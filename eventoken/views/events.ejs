<%- include partials/header.ejs %>

<body>
  <h1>Event List</h1>
  <div id="eventsContainer"></div>
  <button id="loadMoreBtn" class="btn btn-primary mt-2" onclick="loadMoreEvents()">Load More</button>

  <script>
      let currentIndex = 1; // Start index here.
      const eventsPerPage = 6;

      async function loadMoreEvents() {
          try {
              await window.ethereum.request({ method: 'eth_requestAccounts' });
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              const signer = provider.getSigner();

              const contract = new ethers.Contract(contractAddress, contractABI, signer);

              const totalEvents = await contract.nextEventId();
              const eventsContainer = document.getElementById('eventsContainer');
              eventsContainer.innerHTML = ''; // Clears previous content

              for (let i = currentIndex; i < currentIndex + eventsPerPage && i < totalEvents; i++) {
                  const event = await contract.events(i);
                  const ticketsAvailable = await contract.ticketsAvailable(i);

                  const eventElement = document.createElement('div');
                  eventElement.classList.add('event', 'm-4', 'border');
                  eventElement.innerHTML = `
                      <h2>${event.name}</h2>
                      <p>${event.details}</p>
                      <p>Total Tickets: ${event.totalTickets}</p>
                      <p>Price: ${ethers.utils.formatEther(event.price)} ETH</p>
                      <p>Tickets Sold: ${event.ticketsSold}</p>
                      <p>Tickets Available: ${ticketsAvailable}</p>
                      <img src="${event.eventImage}" alt="Event Image" style="max-width: 100px;">
                      <img src="${event.ticketImage}" alt="Ticket Image" style="max-width: 100px;">
                      <button class="btn btn-primary mt-2" onclick="buyTicket(${event.eventId})">Buy Ticket</button>
                  `;
                  eventsContainer.appendChild(eventElement);
              }

              currentIndex += eventsPerPage;
              if (currentIndex >= totalEvents) {
                  document.getElementById('loadMoreBtn').style.display = 'none';
              }
          } catch (error) {
              console.error('Error loading events: ', error);
              alert('Error loading events.');
          }
      }

      async function buyTicket(eventId) {
          try {
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              const signer = provider.getSigner();

              const contract = new ethers.Contract(contractAddress, contractABI, signer);

              // Requests the desired number of tickets from the user
              const quantity = prompt('How many tickets you want to buy?', '1');
              if (!quantity || isNaN(quantity)) {
                  throw new Error('Invalid quantity.');
              }

              console.log("Event ID:" + eventId)
              // Get the event price directly from the contract
              const event = await contract.events(eventId);
              const ticketPrice = event.price;
              console.log("Event:" + event)
              console.log("Ticket price:" + ticketPrice)

              // Calculate the total price of the tickets the user wants to buy
              const totalPrice = ticketPrice.mul(quantity);
              console.log("Total price:" + totalPrice)

              // Call to the purchaseTickets function from contract
              const tx = await contract.purchaseTickets(eventId, quantity, { value: totalPrice });
              await tx.wait();
              
              alert(`Tickets successfully bought for the event! Event ID: ${eventId}.`);
              loadMoreEvents(); // Reloads the event list after purchase
          } catch (error) {
              console.error('Error while buying tickets: ', error);
              alert('Error while buying tickets.');
          }
      }

      // Loads the first events when the page is loaded
      document.addEventListener('DOMContentLoaded', loadMoreEvents);
  </script>
</body>

<%- include partials/footer.ejs %>