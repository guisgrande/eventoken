<%- include partials/header.ejs %>

<body>
  <div class="text-center m-4">
    <h1><i class="bi bi-ticket-perforated first-color"></i> My Tickets</h1>
    <p>All your tickets in one place.</p>
  </div>

  <!-- Element to display the list of tickets -->
  <div class="d-flex justify-content-center">
    <ul id="ticketList" class="list-group col-9"></ul>
  </div>

    <!-- Modal for entering the recipient's address -->
    <div class="modal" id="transferModal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Transfer Ticket</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="transferForm">
              <div class="form-group">
                <label for="recipientAddress">Recipient Address</label>
                <input type="text" class="form-control" id="recipientAddress" required>
                <input type="hidden" id="transferTicketId">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn button-two" data-dismiss="modal">Close</button>
            <button type="submit" class="btn button-one">Transfer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal to list a ticket for sale -->
    <div class="modal fade" id="listTicketModal" tabindex="-1" role="dialog" aria-labelledby="listTicketModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="listTicketModalLabel">List Ticket for Sale</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                  </button>
              </div>
              <div class="modal-body">
                  <form id="listTicketForm">
                      <div class="form-group">
                          <label for="ticketPrice">Ticket price (ETH)</label>
                          <input type="number" step="0.01" min="0" class="form-control" id="ticketPrice" placeholder="Insira o preÃ§o do ticket" required>
                          <input type="hidden" id="sellTicketId">
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn button-two" data-dismiss="modal">Close</button>
                  <button type="button" class="btn button-one" onclick="listTicketForSale()">List for sale</button>
              </div>
          </div>
      </div>
  </div>

</body>

<script>
  console.log("OUTSIDE")

  async function loadTickets() {

    try {
      await window.ethereum.request({ method: 'eth_requestAccounts' });

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      console.log("Signer: " + signer)

      // Get the user's formatted address
      const userAddress = await signer.getAddress();
      console.log("User add: " + userAddress)
      
      const contract = new ethers.Contract(contractAddress, contractABI, signer);

      // Get all user tickets
      const ticketIds = await contract.getUserAllTickets(userAddress);
      console.log("Tickets IDS: " + ticketIds)

      // List for storing detailed information on each ticket
      const ticketDetails = [];
      console.log("Tickets Details before loop: " + ticketDetails)

      // Collect detailed information on each ticket
      for (let i = 0; i < ticketIds.length; i++) {
        const ticketId = ticketIds[i];

        const eventId = await contract.getEventIdByTicket(ticketId);
        console.log("Event ID: " + eventId)
        
        // Get the event details using getEventDetails
        const eventDetails = await contract.getEventDetails(eventId);
        console.log("Event Details: " + eventDetails)
        // Build the object with detailed ticket information
        const ticketInfo = {
          id: ticketId,
          eventName: eventDetails[1],
          eventDetails: eventDetails[2],
          totalTickets: eventDetails[3],
          price: eventDetails[4],
          eventImage: eventDetails[5],
          ticketImage: eventDetails[6],
          ticketsSold: eventDetails[8]
        };

        ticketDetails.push(ticketInfo);
      } // end for

      console.log("Tickets Details after loop: " + ticketDetails)

      // Render tickets on the page
      const ticketList = document.getElementById('ticketList');
      ticketList.innerHTML = '';

      ticketDetails.forEach((ticket) => {
        if (ticket.id > 0) {
          const listItem = document.createElement('li');
          listItem.classList.add('list-group-item', 'm-2', 'bg-dark', 'text-white', 'rounded');

          const divRow = document.createElement('div');
          divRow.classList.add('row');

          const divLeft = document.createElement('div');
          divLeft.classList.add('col-7');

          const divRight = document.createElement('div');
          divRight.classList.add('col-5');

          // Create elements to show sales ticket information
          const eventNameElement = document.createElement('h3');
          eventNameElement.classList.add('mt-2')
          eventNameElement.textContent = `Event Name: ${ticket.eventName}`;

          const eventDetailsElement = document.createElement('p');
          eventDetailsElement.textContent = `Details: ${ticket.eventDetails}`;

          const ticketIdElement = document.createElement('p');
          ticketIdElement.classList.add('m-2');
          ticketIdElement.textContent = `Ticket ID: ${ticket.id}`;

          const priceElement = document.createElement('p');
          priceElement.classList.add('m-2')
          priceElement.textContent = `Price: ${ethers.utils.formatEther(ticket.price)} ETH`;

          const eventImageElement = document.createElement('img');
          eventImageElement.src = ticket.eventImage;
          eventImageElement.alt = 'Event Image';
          eventImageElement.style.maxWidth = '300px';

          const ticketImageElement = document.createElement('img');
          ticketImageElement.src = ticket.ticketImage;
          ticketImageElement.classList.add('m-2')
          ticketImageElement.alt = 'Ticket Image';
          ticketImageElement.style.maxWidth = '150px';

          const transferButton = document.createElement('button');
          transferButton.classList.add('btn', 'button-one', 'm-2');
          transferButton.textContent = 'Transfer Ticket';
          transferButton.onclick = () => openTransferModal(ticket.id);

          const resaleButton = document.createElement('button');
          resaleButton.classList.add('btn', 'button-one', 'm-2');
          resaleButton.textContent = 'Sell Ticket';
          resaleButton.onclick = () => openSellModal(ticket.id);

          // Add elements to the ticket list
          divLeft.appendChild(eventImageElement);
          divLeft.appendChild(eventNameElement);
          divLeft.appendChild(eventDetailsElement);
          divRight.appendChild(ticketImageElement);
          divRight.appendChild(ticketIdElement);
          divRight.appendChild(priceElement);
          divRight.appendChild(transferButton);
          divRight.appendChild(resaleButton);

          divRow.appendChild(divLeft);
          divRow.appendChild(divRight);

          listItem.appendChild(divRow);

          ticketList.appendChild(listItem);
        }
      });

      ticketDetails.forEach((ticket) => {
          console.log(`Ticket ID: ${ticket.id}`);
          console.log(`Event Name: ${ticket.eventName}`);
          console.log(`Details: ${ticket.eventDetails}`);
          console.log(`Total Tickets: ${ticket.totalTickets}`);
          console.log(`Price: ${ethers.utils.formatEther(ticket.price)} ETH`);
          console.log(`Tickets Sold: ${ticket.ticketsSold}`);
          console.log(`Event Image: ${ticket.eventImage}`);
          console.log(`Ticket Image: ${ticket.ticketImage}`);
          console.log('-----------------------------------');
      });

    } catch (error) {
      console.error('Error loading tickets:', error);
      alert('Error loading tickets.');
    }
  } // end loadTickets

  function openTransferModal(ticketId) {
    const transferModal = document.getElementById('transferModal');
    const transferTicketId = document.getElementById('transferTicketId');
    transferTicketId.value = ticketId;
    $(transferModal).modal('show');
  } // End openTransferModal

  function openSellModal(ticketId) {
    const transferModal = document.getElementById('listTicketModal');
    const sellTicketId = document.getElementById('sellTicketId');
    sellTicketId.value = ticketId;
    $(transferModal).modal('show');
  } // End openSellModal

  async function transferTicket(event) {
    event.preventDefault();
    const transferForm = document.getElementById('transferForm');
    const recipientAddress = transferForm.recipientAddress.value;
    const ticketId = transferForm.transferTicketId.value;

    try {
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const contractAddress = ethers.utils.getAddress('0x86e58c90c3232ed333be6a3ef3482194873a3537');
      const contract = new ethers.Contract(contractAddress, contractABI, signer);

      await contract.transferTicket(recipientAddress, ticketId);
      alert('Ticket transferred successfully!');
      loadTickets(); // Reload tickets after transfer
    } catch (error) {
      console.error('Error transferring ticket:', error);
      alert('Error transferring ticket. Check the console for more details.');
    }
  } // End transferTicket
  
  async function listTicketForSale() {
  const ticketId = document.getElementById('sellTicketId').value;
    const ticketPrice = document.getElementById('ticketPrice').value;

    try {
      // Setting up the provider and signer
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const contract = new ethers.Contract(contractAddress, contractABI, signer);

      // Before sending the transaction, set a sufficient gas limit
      const overrides = {
        gasLimit: ethers.utils.hexlify(300000),
      };

      // Call the contract function by passing the overrides
      await contract.listTicketForSale(ticketId, ethers.utils.parseEther(ticketPrice), overrides);

      alert('Ticket listed for sale successfully!');
      $('#listTicketModal').modal('hide'); // Close modal after listing

      loadTickets(); // Reload tickets after listing

    } catch (error) {
      console.error('Error listing ticket for sale:', error);
      alert('Error listing ticket for sale.');
    }
  }

  document.getElementById('transferForm').addEventListener('submit', transferTicket);

  // Call the function to load tickets when loading the page
  window.onload = loadTickets;

</script>

<%- include partials/footer.ejs %>